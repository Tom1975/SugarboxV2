name: Release

on:
  workflow_dispatch :
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
  extract-version:
    runs-on: ubuntu-latest
    steps:
      - name: Get tag/branch name
        id: vars
        run: |
          echo version=${GITHUB_REF#refs/*/} >> $GITHUB_OUTPUT
          echo 'updated version : ' ${{ env.output.version }}
          echo 'updated vars.version : ' ${{ vars.output.version }}
        env:
          Sugarbox_version: ${{ vars.output.version }}
        
  call-workflow-windows:
    #needs: extract-version
    uses:  ./.github/workflows/windows.yml
    with:
      version:  ${GITHUB_REF#refs/*/}
  call-workflow-ubuntu:
    #needs: extract-version
    uses:  ./.github/workflows/ubuntu.yml
    with:
      version: ${GITHUB_REF#refs/*/}
  call-workflow-macos:
    #needs: extract-version
    uses:  ./.github/workflows/macos.yml
    with:
      version: ${GITHUB_REF#refs/*/}
  deploy:
    runs-on: ubuntu-latest
    needs: [call-workflow-windows, call-workflow-ubuntu, call-workflow-macos]
    steps:
      - name: Prepare Release directory
        run: |
          mkdir release_bin
          cd release_bin
          pwd
          ls -l
          
      - name: Download artifact Ubuntu
        uses: actions/download-artifact@v3
        id: art-ubuntu
        with:
          name: SugarboxV2Ubuntu
          
      - name: Download artifact Windows
        uses: actions/download-artifact@v3
        id: art-windows
        with:
          name: SugarboxV2Win32
          
      - name: Download artifact MacOS
        uses: actions/download-artifact@v3
        id: art-macos
        with:
          name: SugarboxV2MacOS

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{steps.art-ubuntu.outputs.download-path}}/*
#            - ${{steps.art-ubuntu.outputs.download-path}}
#            - ${{steps.art-windows.outputs.download-path}}
#            - ${{steps.art-macos.outputs.download-path}}
            
          
